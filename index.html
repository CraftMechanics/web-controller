<!DOCTYPE html>
<html lang="en">

<head>
  <title>Controller</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>

  <div class="container">
    <div class="jumbotron">
      <h1 class="text-center">Controller</h1>
    </div>
    <div class="row">
      <div class="col-sm-4"></div>
      <div class="col-sm-4">
        <button id="forward" type="button" class="btn btn-primary btn-lg btn-block" onclick="setDirection('forward')">Forward</button>
      </div>
      <div class="col-sm-4"></div>
    </div>
    <div class="row">
      <div class="col-sm-4">
        <button id="left" type="button" class="btn btn-primary btn-lg btn-block" onclick="setDirection('left')">Left</button>
      </div>
      <div class="col-sm-4">
        <button id="stop" type="button" class="btn btn-danger btn-lg btn-block active" onclick="setDirection('stop')">Stop</button>
      </div>
      <div class="col-sm-4">
        <button id="right" type="button" class="btn btn-primary btn-lg btn-block" onclick="setDirection('right')">Right</button>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-4"></div>
      <div class="col-sm-4">
        <button id="backward" type="button" class="btn btn-primary btn-lg btn-block" onclick="setDirection('backward')">Backward</button>
      </div>
      <div class="col-sm-4"></div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="slidecontainer well">
          <h3 class="text-center">Turn Speed Control
            <span id="turnSpeedText"></span>
          </h3>
          <input type="range" min="1" max="100" value="1" class="slider" id="turnSpeedSlider">
        </div>
      </div>
      <div class="col-md-6">
        <div class="slidecontainer well">
          <h3 class="text-center">Movement Speed Control
            <span id="movementSpeedText"></span>
          </h3>
          <input type="range" min="1" max="100" value="1" class="slider" id="movementSpeedSlider">
        </div>
      </div>
    </div>
    <div class="row">
      <button id="logtoogler" type="button" class="btn btn-lg btn-block" onclick="toogleLog()">Hide log</button>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <pre id="log" class="pre-scrollable"></pre>
      </div>
    </div>
  </div>

  <script>
    var showLog = true;
    var input = {
      direction:"stop",
      movementSpeed:100,
      turnSpeed:100
    }
    var inputChanged = false;
    var activeButton = "stop";

    function update() {
      writeLog("Updating from server...")
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          writeLog(this.responseText);
          input = JSON.parse(this.responseText);
          setActiveButton(input.direction);
          setSliders();
          setSliderText();
        }
      };
      xhttp.open("GET", "getState.php", true);
      xhttp.send();
    }

    function sendInput() {
      writeLog("Sending input to server...")
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          writeLog(this.responseText);
        }
      };
      xhttp.open("GET", "input.php" + formatPost(input), true);
      xhttp.send();
    }

    function writeLog(msg) {
      document.getElementById("log").innerHTML += getTimestamp() + " " + msg + "\n";
    }

    function getTimestamp() {
      var date = new Date();
      var timestamp = "[";
      timestamp += date.getFullYear();
      timestamp += "-" + date.getMonth();
      timestamp += "-" + date.getDate();
      timestamp += "-" + date.getHours();
      timestamp += ":" + date.getMinutes();
      timestamp += ":" + date.getSeconds() + "]";
      return timestamp;
    }

    function toogleLog() {
      var logtoogler = document.getElementById("logtoogler");
      var log = document.getElementById("log");
      if (showLog) {
        log.classList.add("hidden");
        logtoogler.innerHTML = "Show log";
        showLog = false;
      }
      else {
        log.classList.remove("hidden");
        logtoogler.innerHTML = "Hide log";
        showLog = true;
      }
    }

    function formatPost(obj) {
      post = "?"
      Object.keys(obj).forEach(function (key, index) {
        post += key + "=" + obj[key] + "&";
      });
      return post;
    }

    function setDirection(str){
      if(str != input.direction){
        input.direction = str;
        inputChanged = true;
      }
    }

    function setActiveButton(s){
      var a = document.getElementById(activeButton);
      a.classList.remove("active");
      var b = document.getElementById(s);
      b.classList.add("active");
      activeButton = s;
    }

    function setSliders(){
      document.getElementById("movementSpeedSlider").value = input.movementSpeed;
      document.getElementById("turnSpeedSlider").value = input.turnSpeed;
    }

    function getSliders(){
      movementSpeedSlider = document.getElementById("movementSpeedSlider");
      turnSpeedSlider = document.getElementById("turnSpeedSlider");
      if(input.movementSpeed != movementSpeedSlider.value){
        input.movementSpeed = movementSpeedSlider.value;
        inputChanged = true;
      }
      if(input.turnSpeed != turnSpeedSlider.value){
        input.turnSpeed = turnSpeedSlider.value;
        inputChanged = true;
      }
    }

    function setSliderText(){
      document.getElementById("movementSpeedText").innerHTML = input.movementSpeed;
      document.getElementById("turnSpeedText").innerHTML = input.turnSpeed;
    }

    function refresh(){
      getSliders();
      setSliderText();
      if(inputChanged){
        sendInput();
        oldInput = input;
        inputChanged = false;
      }
      else{
        update();
      }
    }

    setInterval(refresh, 1000)
  </script>

</body>

</html>